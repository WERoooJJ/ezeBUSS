<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ezeBUSS — Оплата</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body{ margin:0; font-family:'Segoe UI',Roboto,sans-serif; background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#f1f5f9 }
    header{ padding:16px 20px; background:rgba(0,0,0,.35); backdrop-filter:blur(10px) }
    .wrap{ max-width:960px; margin:24px auto; padding:0 16px }
    .card{ background:rgba(15,23,42,.9); border:1px solid #1f2a3a; border-radius:24px; padding:22px; box-shadow:0 20px 50px #0008; animation:fadeUp .8s ease }
    label{ display:block; margin-bottom:6px; color:#cbd5e1 }
    input{ width:100%; padding:14px; border-radius:14px; border:1px solid #223047; background:#0b1220; color:#f1f5f9 }
    .btn.primary{ width:100%; padding:16px; border:none; border-radius:14px; font-size:1.1rem; margin-top:16px; background:linear-gradient(90deg,#60a5fa,#3b82f6); color:#fff; font-weight:700; cursor:pointer }
    /* Белый оверлей с шестерёнкой */
    .pay-overlay{ position:fixed; inset:0; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100 }
    .pay-overlay.hidden{ display:none }
    .gear{ width:84px; height:84px; border-radius:50%; position:relative; border:8px solid #e5e7eb; border-top-color:#3b82f6; animation:spin 1s linear infinite }
    .gear::before,.gear::after{ content:""; position:absolute; inset:-16px; border-radius:50%; border:6px dashed #93c5fd }
    .gear::before{ animation:spin 2s linear infinite reverse }
    .gear::after{ inset:-28px; border-color:#c7d2fe; animation:spin 3s linear infinite }
    .overlay-text{ margin-top:14px; color:#0b1220 }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <header><strong>eze<span style="color:#60a5fa">BUSS</span></strong> · оплата</header>
  <main class="wrap">
    <section class="card">
      <h2>Оплата картой</h2>
      <p id="summary" class="muted"></p>

      <form id="cardForm" class="grid grid-2">
        <div class="col-2">
          <label>Номер карты</label>
          <input required maxlength="19" placeholder="0000 0000 0000 0000"
                 oninput="this.value=this.value.replace(/\\D/g,'').replace(/(.{4})/g,'$1 ').trim()">
        </div>
        <div>
          <label>MM/YY</label>
          <input required maxlength="5" placeholder="12/29"
                 oninput="this.value=this.value.replace(/[^\\d/]/g,'').slice(0,5)">
        </div>
        <div>
          <label>CVV</label>
          <input required maxlength="3" placeholder="123"
                 oninput="this.value=this.value.replace(/\\D/g,'').slice(0,3)">
        </div>
        <div class="col-2">
          <label>Имя держателя</label>
          <input required placeholder="IVAN IVANOV">
        </div>
        <div class="col-2"><button class="btn primary" type="submit">Оплатить</button></div>
      </form>

      <div id="fail" class="hidden alert">Неверные данные карты. Попробуйте снова.</div>
      <div id="ticket" class="hidden ticket"></div>
    </section>
  </main>

  <div id="payOverlay" class="pay-overlay hidden" role="status" aria-live="polite">
    <div class="gear" aria-hidden="true"></div>
    <div class="overlay-text">Проводим оплату…</div>
  </div>

  <script>
    const from=sessionStorage.getItem('ez_from');
    const to=sessionStorage.getItem('ez_to');
    const dateLabel=sessionStorage.getItem('ez_date');
    const cls=sessionStorage.getItem('ez_cls');
    const price=sessionStorage.getItem('ez_price');
    if(!from||!to||!dateLabel||!cls||!price) location.href='index.html';
    document.getElementById('summary').textContent=`${from} → ${to} · ${dateLabel} · ${cls} · ${price}`;

    function code(n){ const abc='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let out=''; for(let i=0;i<n;i++) out+=abc[Math.floor(Math.random()*abc.length)]; return out; }

    const form=document.getElementById('cardForm');
    const overlay=document.getElementById('payOverlay');
    const fail=document.getElementById('fail');
    const ticket=document.getElementById('ticket');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      fail.classList.add('hidden'); ticket.classList.add('hidden');
      overlay.classList.remove('hidden');               // белый экран + шестерёнка
      await new Promise(r=>setTimeout(r,20000));        // ~20 секунд

      try{
        const res=await fetch(`payment_status.json?ts=${Date.now()}`);
        const data=await res.json();
        overlay.classList.add('hidden');
        if(data.status==='completed'){
          const c=code(5);
          ticket.innerHTML=
            `<h3 style='color:#16a34a'>Оплата успешна</h3>
             <p class='muted'>Билет оформлен.</p>
             <div class='ticket-grid'>
               <div><strong>Код</strong><div class='mono'>${c}</div></div>
               <div><strong>Класс</strong><div>${cls}</div></div>
               <div><strong>Маршрут</strong><div>${from} → ${to}</div></div>
               <div><strong>Дата</strong><div>${dateLabel}</div></div>
               <div><strong>Цена</strong><div>${price}</div></div>
             </div>`;
          ticket.classList.remove('hidden');
          form.classList.add('hidden');
        } else {
          fail.classList.remove('hidden');
        }
      } catch(err){
        overlay.classList.add('hidden');
        fail.textContent='Сеть недоступна. Повторите попытку.';
        fail.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
